<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NHL Projections</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' }
  </script>
</head>

<body class="bg-slate-100 text-slate-900 dark:bg-slate-900 dark:text-slate-100">

<div class="max-w-7xl mx-auto p-4">

  <!-- Header -->
  <div class="flex justify-between items-center mb-4">
    <h1 class="text-3xl font-bold">NHL Projections</h1>
    <div class="flex gap-2">
      <button onclick="showProjections()"
        class="px-4 py-2 rounded bg-slate-300 dark:bg-slate-700">
        Projection List
      </button>

      <button onclick="showLineup()"
        class="px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700">
        Today‚Äôs Lineup
      </button>

      <button onclick="toggleTheme()"
        class="px-4 py-2 rounded bg-slate-200 dark:bg-slate-700">
        üåô / ‚òÄÔ∏è
      </button>
    </div>
  </div>

  <!-- Search -->
  <div id="searchBar" class="mb-4">
    <input id="playerSearch" type="text" placeholder="Search player"
      class="px-3 py-2 rounded border dark:border-slate-700 bg-white dark:bg-slate-800 w-full max-w-sm">
  </div>

  <!-- Loading -->
  <div id="loading" class="hidden text-center py-6 text-lg">
    Loading NHL data...
  </div>

  <!-- Projection Table -->
  <div id="projectionView" class="overflow-x-auto rounded-lg">
    <table class="w-full bg-white dark:bg-slate-800">
      <thead class="sticky top-0 bg-slate-200 dark:bg-slate-700">
        <tr>
          <th class="p-2 cursor-pointer" onclick="sortBy('player')">Player</th>
          <th class="p-2 cursor-pointer" onclick="sortBy('projection')">Projection</th>
          <th class="p-2 cursor-pointer" onclick="sortBy('boost')">Boost</th>
          <th class="p-2 cursor-pointer" onclick="sortBy('b1')">B1</th>
          <th class="p-2 cursor-pointer" onclick="sortBy('b2')">B2</th>
          <th class="p-2 cursor-pointer" onclick="sortBy('b3')">B3</th>
          <th class="p-2 cursor-pointer" onclick="sortBy('b4')">B4</th>
          <th class="p-2 cursor-pointer" onclick="sortBy('b5')">B5</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <!-- Best Lineup -->
  <div id="lineupView" class="mt-8 hidden">
    <h2 class="text-2xl font-bold mb-2">Today‚Äôs Optimal Lineup</h2>

    <table class="w-full bg-white dark:bg-slate-800 rounded-lg">
      <thead class="bg-slate-200 dark:bg-slate-700">
        <tr>
          <th class="p-2 text-left">Player</th>
          <th class="p-2 text-right">Projection</th>
          <th class="p-2 text-right">Boost</th>
          <th class="p-2 text-right">Multiplier</th>
          <th class="p-2 text-right">Score</th>
        </tr>
      </thead>
      <tbody id="bestLineupBody"></tbody>
      <tfoot>
        <tr class="font-bold border-t dark:border-slate-700">
          <td class="p-2">Total</td>
          <td colspan="4" id="bestLineupTotal" class="p-2 text-right"></td>
        </tr>
      </tfoot>
    </table>
  </div>

</div>

<script>
const DATA_URL =
"https://script.google.com/macros/s/AKfycbxhMK_vKv7SFxoyIGmf8yHmi74-8BX592IE7PrQxR6WSUh8C-7vSom1kt04n0tNT1vE/exec";

let allData = [];
let sortKey = "projection";
let sortDir = -1;

/* ---------- LOAD ---------- */
async function loadData() {
  loading.classList.remove("hidden");
  const res = await fetch(DATA_URL);
  allData = await res.json();
  loading.classList.add("hidden");
  render();
}

/* ---------- RENDER TABLE ---------- */
function render() {
  const search = playerSearch.value.toLowerCase();

  let filtered = allData.filter(p =>
    !search || p.player.toLowerCase().includes(search)
  );

  filtered.sort((a, b) => {
    const x = a[sortKey] ?? 0;
    const y = b[sortKey] ?? 0;
    return (x > y ? 1 : -1) * sortDir;
  });

  tableBody.innerHTML = "";
  filtered.forEach(p => {
    tableBody.insertAdjacentHTML("beforeend", `
      <tr class="border-t dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-700">
        <td class="p-2">${p.player}</td>
        <td class="p-2 text-right">${(p.projection ?? 0).toFixed(2)}</td>
        <td class="p-2 text-right text-green-400 font-bold">${(p.boost ?? 0).toFixed(1)}</td>
        <td class="p-2 text-right">${(p.b1 ?? 0).toFixed(2)}</td>
        <td class="p-2 text-right">${(p.b2 ?? 0).toFixed(2)}</td>
        <td class="p-2 text-right">${(p.b3 ?? 0).toFixed(2)}</td>
        <td class="p-2 text-right">${(p.b4 ?? 0).toFixed(2)}</td>
        <td class="p-2 text-right">${(p.b5 ?? 0).toFixed(2)}</td>
      </tr>
    `);
  });
}

/* ---------- SORT ---------- */
function sortBy(key) {
  if (sortKey === key) sortDir *= -1;
  else { sortKey = key; sortDir = -1; }
  render();
}

/* ---------- VIEWS ---------- */
function showProjections() {
  projectionView.classList.remove("hidden");
  lineupView.classList.add("hidden");
}

function showLineup() {
  projectionView.classList.add("hidden");
  lineupView.classList.remove("hidden");
  computeBestLineup();
}

/* ---------- THEME ---------- */
function toggleTheme() {
  document.documentElement.classList.toggle("dark");
}

/* ---------- OPTIMIZER ---------- */
function computeBestLineup() {
  const multipliers = [2, 1.8, 1.6, 1.4, 1.2];

  const top20 = [...allData]
    .filter(p => p.b3 != null)
    .sort((a, b) => b.b3 - a.b3)
    .slice(0, 20);

  let bestScore = -Infinity;
  let bestLineup = null;
  let bestMults = null;

  function permute(arr, l = 0, res = []) {
    if (l === arr.length) { res.push(arr.slice()); return; }
    for (let i = l; i < arr.length; i++) {
      [arr[l], arr[i]] = [arr[i], arr[l]];
      permute(arr, l + 1, res);
      [arr[l], arr[i]] = [arr[i], arr[l]];
    }
  }

  const perms = [];
  permute(multipliers.slice(), 0, perms);

  function backtrack(start, lineup) {
    if (lineup.length === 5) {
      perms.forEach(m => {
        let score = 0;
        for (let i = 0; i < 5; i++) {
          score += lineup[i].projection * (m[i] + lineup[i].boost);
        }
        if (score > bestScore) {
          bestScore = score;
          bestLineup = [...lineup];
          bestMults = [...m];
        }
      });
      return;
    }
    for (let i = start; i < top20.length; i++) {
      backtrack(i + 1, [...lineup, top20[i]]);
    }
  }

  backtrack(0, []);
  renderBestLineup(bestLineup, bestMults, bestScore);
}

/* ---------- RENDER LINEUP ---------- */
function renderBestLineup(lineup, mults, total) {
  bestLineupBody.innerHTML = "";
  lineup.forEach((p, i) => {
    const score = p.projection * (mults[i] + p.boost);
    bestLineupBody.insertAdjacentHTML("beforeend", `
      <tr class="border-t dark:border-slate-700">
        <td class="p-2">${p.player}</td>
        <td class="p-2 text-right">${p.projection.toFixed(2)}</td>
        <td class="p-2 text-right text-green-400">${p.boost.toFixed(1)}</td>
        <td class="p-2 text-right">${mults[i].toFixed(1)}</td>
        <td class="p-2 text-right font-bold">${score.toFixed(2)}</td>
      </tr>
    `);
  });
  bestLineupTotal.textContent = total.toFixed(2);
}

playerSearch.addEventListener("input", render);
loadData();
</script>

</body>
</html>
