<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Projections Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' }
  </script>
</head>

<body class="bg-slate-100 text-slate-900 dark:bg-slate-900 dark:text-slate-100">

<div class="max-w-7xl mx-auto p-4">

  <!-- HEADER -->
  <div class="flex flex-wrap gap-2 justify-between items-center mb-4">
    <h1 id="pageTitle" class="text-3xl font-bold">NHL Projections</h1>

    <div class="flex gap-2 flex-wrap">
      <button onclick="loadLeague('nhl','proj')" class="btn">NHL Projections</button>
      <button onclick="loadLeague('nhl','lineup')" class="btn">NHL Draft</button>
      <button onclick="loadLeague('nba','proj')" class="btn">NBA Projections</button>
      <button onclick="loadLeague('nba','lineup')" class="btn">NBA Draft</button>
      <button onclick="toggleTheme()" class="btn">üåô / ‚òÄÔ∏è</button>
    </div>
  </div>

  <!-- SEARCH -->
  <div class="mb-4">
    <input id="playerSearch" placeholder="Search player"
      class="px-3 py-2 rounded border w-full max-w-sm dark:bg-slate-800">
  </div>

  <!-- LOADING -->
  <div id="loading" class="hidden text-center py-6 text-lg">
    Loading data...
  </div>

  <!-- PROJECTIONS -->
  <div id="projectionView" class="overflow-x-auto rounded-lg"></div>

  <!-- LINEUP -->
  <div id="lineupView" class="hidden mt-6">
    <h2 class="text-2xl font-bold mb-2">Optimal Lineup</h2>
    <table class="w-full bg-white dark:bg-slate-800 rounded-lg">
      <thead class="bg-slate-200 dark:bg-slate-700">
        <tr>
          <th class="p-2 text-left">Player</th>
          <th class="p-2 text-right">Proj</th>
          <th class="p-2 text-right">Boost</th>
          <th class="p-2 text-right">Mult</th>
          <th class="p-2 text-right">Score</th>
        </tr>
      </thead>
      <tbody id="lineupBody"></tbody>
      <tfoot>
        <tr class="font-bold border-t">
          <td class="p-2">Total</td>
          <td colspan="4" id="lineupTotal" class="p-2 text-right"></td>
        </tr>
      </tfoot>
    </table>
  </div>

</div>

<script>
/* ================= CONFIG ================= */

const BASE_URL =
"https://script.google.com/macros/s/AKfycbyINrZV6oyDhAQKeeuui5TOhTMKsZABb0SHYHbN4LXPFNBRykOBj0rvMAjXGMdJtf6U/exec";

let league = "nhl";
let mode = "proj";
let allData = [];

/* ================= LOAD ================= */

async function loadLeague(lg, md) {
  league = lg;
  mode = md;

  pageTitle.textContent =
    lg.toUpperCase() + (md === "proj" ? " Projections" : " Today‚Äôs Draft");

  projectionView.classList.toggle("hidden", md !== "proj");
  lineupView.classList.toggle("hidden", md !== "lineup");

  loading.classList.remove("hidden");

  const res = await fetch(`${BASE_URL}?league=${lg}`);
  allData = await res.json();

  loading.classList.add("hidden");

  if (md === "proj") renderTable();
  else computeLineup();
}

/* ================= TABLE ================= */

function renderTable() {
  const search = playerSearch.value.toLowerCase();
  const rows = allData.filter(p =>
    !search || p.player.toLowerCase().includes(search)
  );

  let html = `
  <table class="w-full bg-white dark:bg-slate-800 text-sm">
    <thead class="bg-slate-200 dark:bg-slate-700">
      <tr>
        <th class="p-2">Player</th>
        ${league === "nhl" ? `
          <th class="p-2">Team</th>
          <th class="p-2">G</th>
          <th class="p-2">A</th>
          <th class="p-2">P</th>
          <th class="p-2">SOG</th>
          <th class="p-2">BLK</th>` : ``}
        <th class="p-2">Proj</th>
        <th class="p-2">Boost</th>
        <th class="p-2">B1</th>
        <th class="p-2">B2</th>
        <th class="p-2">B3</th>
        <th class="p-2">B4</th>
        <th class="p-2">B5</th>
      </tr>
    </thead><tbody>`;

  rows.forEach(p => {
    html += `
    <tr class="border-t">
      <td class="p-2">${p.player}</td>
      ${league === "nhl" ? `
        <td class="p-2 text-center">${p.team}</td>
        <td class="p-2 text-right">${p.goals.toFixed(2)}</td>
        <td class="p-2 text-right">${p.assists.toFixed(2)}</td>
        <td class="p-2 text-right">${p.points.toFixed(2)}</td>
        <td class="p-2 text-right">${p.shots.toFixed(1)}</td>
        <td class="p-2 text-right">${p.blocks.toFixed(1)}</td>` : ``}
      <td class="p-2 text-right">${p.projection.toFixed(2)}</td>
      <td class="p-2 text-right text-green-400">${p.boost.toFixed(1)}</td>
      <td class="p-2 text-right">${p.b1.toFixed(2)}</td>
      <td class="p-2 text-right">${p.b2.toFixed(2)}</td>
      <td class="p-2 text-right">${p.b3.toFixed(2)}</td>
      <td class="p-2 text-right">${p.b4.toFixed(2)}</td>
      <td class="p-2 text-right">${p.b5.toFixed(2)}</td>
    </tr>`;
  });

  projectionView.innerHTML = html + "</tbody></table>";
}

/* ================= LINEUP ================= */

function computeLineup() {
  const mults = [2, 1.8, 1.6, 1.4, 1.2];

  const pool = [...allData]
    .sort((a,b) => b.b3 - a.b3)
    .slice(0,20);

  let best = { score: -1 };

  function permute(arr, l, res) {
    if (l === arr.length) return res.push(arr.slice());
    for (let i=l;i<arr.length;i++){
      [arr[l],arr[i]]=[arr[i],arr[l]];
      permute(arr,l+1,res);
      [arr[l],arr[i]]=[arr[i],arr[l]];
    }
  }

  const perms=[]; permute(mults.slice(),0,perms);

  function choose(start, picked) {
    if (picked.length===5) {
      perms.forEach(m=>{
        let s=0;
        for (let i=0;i<5;i++)
          s+=picked[i].projection*(m[i]+picked[i].boost);
        if (s>best.score)
          best={score:s,players:[...picked],mults:[...m]};
      });
      return;
    }
    for (let i=start;i<pool.length;i++)
      choose(i+1,[...picked,pool[i]]);
  }

  choose(0,[]);
  renderLineup(best);
}

function renderLineup(best) {
  lineupBody.innerHTML = "";

  const rows = best.players.map((p,i)=>({
    p, m:best.mults[i],
    s:p.projection*(best.mults[i]+p.boost)
  })).sort((a,b)=>b.m-a.m);

  rows.forEach(r=>{
    lineupBody.insertAdjacentHTML("beforeend",`
      <tr class="border-t">
        <td class="p-2">${r.p.player}</td>
        <td class="p-2 text-right">${r.p.projection.toFixed(2)}</td>
        <td class="p-2 text-right text-green-400">${r.p.boost.toFixed(1)}</td>
        <td class="p-2 text-right">${r.m.toFixed(1)}</td>
        <td class="p-2 text-right font-bold">${r.s.toFixed(2)}</td>
      </tr>
    `);
  });

  lineupTotal.textContent = best.score.toFixed(2);
}

/* ================= UTILS ================= */

function toggleTheme(){
  document.documentElement.classList.toggle("dark");
}

playerSearch.addEventListener("input", renderTable);

/* INITIAL LOAD */
loadLeague("nhl","proj");
</script>

<style>
.btn{padding:.5rem 1rem;border-radius:.375rem;background:#cbd5e1}
.dark .btn{background:#334155}
</style>

</body>
</html>
