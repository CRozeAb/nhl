<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <title>Projections Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' }
  </script>
</head>

<body class="bg-slate-950 text-slate-100">

<div class="aurora-bg" aria-hidden="true"></div>
<div class="aurora-noise" aria-hidden="true"></div>

<!-- Random color deviation + blur overlay (no ripple) -->
<div id="transitionOverlay" class="transition-overlay hidden" aria-hidden="true"></div>

<!-- Blur target -->
<div id="app" class="relative z-10">
  <div class="max-w-7xl mx-auto p-4">

    <div class="flex flex-wrap gap-3 justify-between items-center mb-4">
      <div class="flex items-center gap-3">
        <div class="brand-badge">
          <span class="brand-dot"></span>
          <span class="font-bold tracking-wide">Projections Hub</span>
        </div>
        <h1 id="pageTitle" class="text-2xl md:text-3xl font-bold">Main Menu</h1>
      </div>

      <div class="flex gap-2 flex-wrap">
        <button onclick="goHome()" class="btn btn-soft">Home</button>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-[260px,1fr] gap-4">

      <aside class="glass-card p-3 md:p-4">
        <div class="mb-3">
          <div class="text-xs uppercase tracking-widest opacity-70 mb-2">Navigation</div>
        </div>

        <div class="flex flex-col gap-2">
          <button onclick="loadLeague('nhl','proj')" class="nav-btn">
            <span class="nav-icon">üèí</span>
            <span class="flex-1 text-left"><div class="font-semibold">NHL Projections</div></span>
            <span class="nav-arrow">‚Üí</span>
          </button>

          <button onclick="loadLeague('nhl','lineup')" class="nav-btn">
            <span class="nav-icon">üìã</span>
            <span class="flex-1 text-left"><div class="font-semibold">NHL Draft</div></span>
            <span class="nav-arrow">‚Üí</span>
          </button>

          <button onclick="loadLeague('nhl','team')" class="nav-btn">
            <span class="nav-icon">üèÜ</span>
            <span class="flex-1 text-left"><div class="font-semibold">NHL Best Team</div></span>
            <span class="nav-arrow">‚Üí</span>
          </button>

          <div class="h-px my-2 bg-white/10"></div>

          <button onclick="loadLeague('nba','proj')" class="nav-btn">
            <span class="nav-icon">üèÄ</span>
            <span class="flex-1 text-left"><div class="font-semibold">NBA Projections</div></span>
            <span class="nav-arrow">‚Üí</span>
          </button>

          <button onclick="loadLeague('nba','lineup')" class="nav-btn">
            <span class="nav-icon">üìã</span>
            <span class="flex-1 text-left"><div class="font-semibold">NBA Draft</div></span>
            <span class="nav-arrow">‚Üí</span>
          </button>
        </div>
      </aside>

      <main class="glass-card p-3 md:p-4 min-h-[420px]">
        <div id="homeView" class="fade-in">
          <div class="hero-card p-6 md:p-8">
            <div class="hero-glow" aria-hidden="true"></div>
            <div class="relative z-10">
              <div class="text-xs uppercase tracking-[0.25em] opacity-70 mb-2">Main Menu</div>
              <div class="text-2xl md:text-3xl font-extrabold leading-tight">Choose a tab to load</div>
            </div>
          </div>
        </div>

        <div id="searchWrap" class="mb-4 hidden fade-in">
          <input id="playerSearch" placeholder="Search player"
            class="px-3 py-2 rounded border w-full max-w-sm bg-white/5 backdrop-blur-md border-white/10 focus:outline-none focus:ring-2 focus:ring-emerald-200/20">
        </div>

        <div id="loading" class="hidden text-center py-10 text-lg fade-in">
          <div class="spinner mx-auto mb-3"></div>
          Loading data...
        </div>

        <div id="projectionView" class="overflow-x-auto rounded-lg hidden fade-in"></div>

        <div id="lineupView" class="hidden mt-2 fade-in">
          <h2 class="text-2xl font-bold mb-2">Optimal Lineup</h2>
          <div class="table-wrap">
            <table class="w-full rounded-lg overflow-hidden">
              <thead class="bg-white/10">
                <tr>
                  <th class="p-2 text-left">Player</th>
                  <th class="p-2 text-right">Proj</th>
                  <th class="p-2 text-right">Boost</th>
                  <th class="p-2 text-right">Mult</th>
                  <th class="p-2 text-right">Score</th>
                </tr>
              </thead>
              <tbody id="lineupBody" class="bg-white/5"></tbody>
              <tfoot>
                <tr class="font-bold border-t border-white/10">
                  <td class="p-2">Total</td>
                  <td colspan="4" id="lineupTotal" class="p-2 text-right"></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>

        <div id="teamView" class="hidden mt-2 fade-in">
          <div class="flex flex-wrap items-end justify-between gap-2 mb-2">
            <h2 class="text-2xl font-bold">Highest Projected Team</h2>
            <div class="text-sm opacity-80">
              Team: <span id="bestTeamName" class="font-bold"></span>
            </div>
          </div>

          <div class="table-wrap">
            <table class="w-full rounded-lg overflow-hidden">
              <thead class="bg-white/10">
                <tr>
                  <th class="p-2 text-left">Player</th>
                  <th class="p-2 text-center">Team</th>
                  <th class="p-2 text-right">PB3</th>
                  <th class="p-2 text-right">Proj</th>
                  <th class="p-2 text-right">Boost</th>
                  <th class="p-2 text-right">Mult</th>
                  <th class="p-2 text-right">Score</th>
                </tr>
              </thead>
              <tbody id="teamBody" class="bg-white/5"></tbody>
              <tfoot>
                <tr class="font-bold border-t border-white/10">
                  <td class="p-2">Total</td>
                  <td colspan="6" id="teamTotal" class="p-2 text-right"></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>

      </main>
    </div>

    <div class="mt-4 text-xs opacity-70 flex items-center justify-end">
      <div class="opacity-70">Created by croze</div>
    </div>

  </div>
</div>

<script>
const BASE_URL =
"https://script.google.com/macros/s/AKfycbyINrZV6oyDhAQKeeuui5TOhTMKsZABb0SHYHbN4LXPFNBRykOBj0rvMAjXGMdJtf6U/exec";

let league = "nhl";
let mode = "proj";
let allData = [];

/* ===== Random color deviation + blur during loading ===== */
let colorTimer = null;

function rand(min, max) {
  return min + Math.random() * (max - min);
}

function applyRandomColorDeviation() {
  const o = document.getElementById("transitionOverlay");

  // Push positions around harder for more "randomness"
  o.style.setProperty("--x1", rand(5, 95).toFixed(1) + "%");
  o.style.setProperty("--y1", rand(5, 95).toFixed(1) + "%");
  o.style.setProperty("--x2", rand(5, 95).toFixed(1) + "%");
  o.style.setProperty("--y2", rand(5, 95).toFixed(1) + "%");
  o.style.setProperty("--x3", rand(5, 95).toFixed(1) + "%");
  o.style.setProperty("--y3", rand(5, 95).toFixed(1) + "%");
  o.style.setProperty("--x4", rand(5, 95).toFixed(1) + "%");
  o.style.setProperty("--y4", rand(5, 95).toFixed(1) + "%");

  // Stronger alpha deviation
  o.style.setProperty("--a1", rand(0.18, 0.55).toFixed(3));
  o.style.setProperty("--a2", rand(0.16, 0.52).toFixed(3));
  o.style.setProperty("--a3", rand(0.12, 0.46).toFixed(3));
  o.style.setProperty("--a4", rand(0.10, 0.42).toFixed(3));

  // Randomize hue + saturation + brightness a lot more
  o.style.setProperty("--h", rand(-50, 80).toFixed(1) + "deg");
  o.style.setProperty("--sat", rand(1.35, 2.15).toFixed(2));
  o.style.setProperty("--bri", rand(1.05, 1.28).toFixed(2));

  // Blur ramp + opacity flutter
  o.style.setProperty("--blur", rand(10, 18).toFixed(0) + "px");
  o.style.setProperty("--op", rand(0.70, 0.95).toFixed(2));
}

function startTransition() {
  const o = document.getElementById("transitionOverlay");
  o.classList.remove("hidden");
  document.documentElement.classList.add("is-transitioning");

  applyRandomColorDeviation();

  // Faster updates = more random deviation
  if (colorTimer) clearInterval(colorTimer);
  colorTimer = setInterval(applyRandomColorDeviation, 70);
}

function endTransition() {
  const o = document.getElementById("transitionOverlay");

  if (colorTimer) clearInterval(colorTimer);
  colorTimer = null;

  o.classList.add("out");

  setTimeout(() => {
    o.classList.add("hidden");
    o.classList.remove("out");
    document.documentElement.classList.remove("is-transitioning");
  }, 260);
}

/* ================= HOME ================= */

async function goHome() {
  startTransition();

  mode = "home";
  pageTitle.textContent = "Main Menu";

  homeView.classList.remove("hidden");
  searchWrap.classList.add("hidden");
  projectionView.classList.add("hidden");
  lineupView.classList.add("hidden");
  teamView.classList.add("hidden");
  loading.classList.add("hidden");

  endTransition();
}

/* ================= LOAD ================= */

async function loadLeague(lg, md) {
  startTransition();

  league = lg;
  mode = md;

  pageTitle.textContent =
    lg.toUpperCase() + (
      md === "proj" ? " Projections" :
      md === "lineup" ? " Today‚Äôs Draft" :
      " Best Team"
    );

  homeView.classList.toggle("hidden", true);

  projectionView.classList.toggle("hidden", md !== "proj");
  lineupView.classList.toggle("hidden", md !== "lineup");
  teamView.classList.toggle("hidden", md !== "team");
  searchWrap.classList.toggle("hidden", md !== "proj");

  loading.classList.remove("hidden");

  try {
    const res = await fetch(`${BASE_URL}?league=${lg}`);
    allData = await res.json();
  } finally {
    loading.classList.add("hidden");
  }

  if (md === "proj") renderTable();
  else if (md === "lineup") computeLineup();
  else computeBestTeam();

  endTransition();
}

/* ================= TABLE ================= */

function renderTable() {
  const search = playerSearch.value.toLowerCase();
  const rows = allData.filter(p =>
    !search || (p.player || "").toLowerCase().includes(search)
  );

  let html = `
  <table class="w-full text-sm rounded-lg overflow-hidden">
    <thead class="bg-white/10">
      <tr>
        <th class="p-2">Player</th>
        ${league === "nhl" ? `
          <th class="p-2">Team</th>
          <th class="p-2">G</th>
          <th class="p-2">A</th>
          <th class="p-2">P</th>
          <th class="p-2">SOG</th>
          <th class="p-2">BLK</th>` : ``}
        <th class="p-2">Proj</th>
        <th class="p-2">Boost</th>
        <th class="p-2">B1</th>
        <th class="p-2">B2</th>
        <th class="p-2">B3</th>
        <th class="p-2">B4</th>
        <th class="p-2">B5</th>
      </tr>
    </thead><tbody class="bg-white/5">`;

  rows.forEach(p => {
    html += `
    <tr class="border-t border-white/10 hover-row">
      <td class="p-2">${p.player ?? ""}</td>
      ${league === "nhl" ? `
        <td class="p-2 text-center">${p.team ?? ""}</td>
        <td class="p-2 text-right">${Number(p.goals ?? 0).toFixed(2)}</td>
        <td class="p-2 text-right">${Number(p.assists ?? 0).toFixed(2)}</td>
        <td class="p-2 text-right">${Number(p.points ?? 0).toFixed(2)}</td>
        <td class="p-2 text-right">${Number(p.shots ?? 0).toFixed(1)}</td>
        <td class="p-2 text-right">${Number(p.blocks ?? 0).toFixed(1)}</td>` : ``}
      <td class="p-2 text-right">${Number(p.projection ?? 0).toFixed(2)}</td>
      <td class="p-2 text-right text-emerald-200">${Number(p.boost ?? 0).toFixed(1)}</td>
      <td class="p-2 text-right">${Number(p.b1 ?? 0).toFixed(2)}</td>
      <td class="p-2 text-right">${Number(p.b2 ?? 0).toFixed(2)}</td>
      <td class="p-2 text-right">${Number(p.b3 ?? 0).toFixed(2)}</td>
      <td class="p-2 text-right">${Number(p.b4 ?? 0).toFixed(2)}</td>
      <td class="p-2 text-right">${Number(p.b5 ?? 0).toFixed(2)}</td>
    </tr>`;
  });

  projectionView.innerHTML = html + "</tbody></table>";
}

/* ================= SHARED SOLVER ================= */

function computeBestLineupFromPool(pool) {
  const mults = [2, 1.8, 1.6, 1.4, 1.2];
  if (!Array.isArray(pool) || pool.length < 5) return null;

  const perms = [];
  (function permute(a, l) {
    if (l === a.length) return perms.push(a.slice());
    for (let i = l; i < a.length; i++) {
      [a[l], a[i]] = [a[i], a[l]];
      permute(a, l + 1);
      [a[l], a[i]] = [a[i], a[l]];
    }
  })(mults.slice(), 0);

  let best = { score: -1 };

  function choose(start, picked) {
    if (picked.length === 5) {
      perms.forEach(m => {
        let s = 0;
        for (let i = 0; i < 5; i++) {
          s += picked[i].projection * (m[i] + picked[i].boost);
        }
        if (s > best.score)
          best = { score: s, players: picked.slice(), mults: m.slice() };
      });
      return;
    }
    for (let i = start; i < pool.length; i++) {
      choose(i + 1, picked.concat(pool[i]));
    }
  }

  choose(0, []);
  return best;
}

/* ================= LINEUP ================= */

function computeLineup() {
  const pool = [...allData]
    .sort((a, b) => b.b3 - a.b3)
    .slice(0, 20);

  const best = computeBestLineupFromPool(pool);
  if (!best) return;
  renderLineup(best);
}

function renderLineup(best) {
  lineupBody.innerHTML = "";

  const rows = best.players.map((p, i) => ({
    p,
    m: best.mults[i],
    s: p.projection * (best.mults[i] + p.boost)
  })).sort((a, b) => b.m - a.m);

  rows.forEach(r => {
    lineupBody.insertAdjacentHTML("beforeend", `
      <tr class="border-t border-white/10 hover-row">
        <td class="p-2">${r.p.player}</td>
        <td class="p-2 text-right">${r.p.projection.toFixed(2)}</td>
        <td class="p-2 text-right text-emerald-200">${r.p.boost.toFixed(1)}</td>
        <td class="p-2 text-right">${r.m.toFixed(1)}</td>
        <td class="p-2 text-right font-bold">${r.s.toFixed(2)}</td>
      </tr>
    `);
  });

  lineupTotal.textContent = best.score.toFixed(2);
}

/* ================= BEST TEAM ================= */

function computeBestTeam() {
  const byTeam = {};
  allData.forEach(p => {
    const t = (p.team ?? "UNK").toString().trim() || "UNK";
    if (!byTeam[t]) byTeam[t] = [];
    byTeam[t].push(p);
  });

  let bestTeam = null;

  Object.entries(byTeam).forEach(([team, players]) => {
    const top6 = players
      .slice()
      .sort((a, b) => b.b3 - a.b3)
      .slice(0, 6);

    const best = computeBestLineupFromPool(top6);
    if (!best) return;

    if (!bestTeam || best.score > bestTeam.best.score) {
      bestTeam = { team, best };
    }
  });

  if (!bestTeam) return;

  bestTeamName.textContent = bestTeam.team;
  teamBody.innerHTML = "";

  bestTeam.best.players.forEach((p, i) => {
    const m = bestTeam.best.mults[i];
    const s = p.projection * (m + p.boost);

    teamBody.insertAdjacentHTML("beforeend", `
      <tr class="border-t border-white/10 hover-row">
        <td class="p-2">${p.player}</td>
        <td class="p-2 text-center">${p.team}</td>
        <td class="p-2 text-right">${p.b3.toFixed(2)}</td>
        <td class="p-2 text-right">${p.projection.toFixed(2)}</td>
        <td class="p-2 text-right text-emerald-200">${p.boost.toFixed(1)}</td>
        <td class="p-2 text-right">${m.toFixed(1)}</td>
        <td class="p-2 text-right font-bold">${s.toFixed(2)}</td>
      </tr>
    `);
  });

  teamTotal.textContent = bestTeam.best.score.toFixed(2);
}

playerSearch.addEventListener("input", renderTable);
goHome();
</script>

<style>
/* Blur the whole app while transitioning */
.is-transitioning #app{
  filter: blur(12px) saturate(1.25) contrast(1.05);
  transform: translateZ(0);
}

/* Buttons */
.btn{
  padding:.55rem 1rem;border-radius:.6rem;
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.10);
  backdrop-filter: blur(10px);-webkit-backdrop-filter: blur(10px);
  transition: transform .18s ease, box-shadow .18s ease, background .18s ease;
}
.btn:hover{ transform: translateY(-2px); box-shadow: 0 16px 40px rgba(0,0,0,.55); background: rgba(255,255,255,.08); }
.btn:active{ transform: translateY(0); }
.btn-soft{ background: rgba(255,255,255,.05); }

.glass-card{
  border-radius: 1rem;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(2,6,23,.35);
  box-shadow: 0 18px 55px rgba(0,0,0,.55);
  backdrop-filter: blur(14px);-webkit-backdrop-filter: blur(14px);
}

.nav-btn{
  display:flex;align-items:center;gap:.75rem;
  padding:.85rem .9rem;border-radius:.9rem;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.05);
  transition: transform .18s ease, box-shadow .18s ease, background .18s ease;
}
.nav-btn:hover{ transform: translateY(-2px); background: rgba(255,255,255,.08); box-shadow: 0 16px 38px rgba(0,0,0,.55); }
.nav-icon{
  width: 38px;height: 38px;display:grid;place-items:center;
  border-radius: .85rem;background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.10);
}
.nav-arrow{ opacity:.75; transition: transform .18s ease, opacity .18s ease; }
.nav-btn:hover .nav-arrow{ transform: translateX(3px); opacity: 1; }

.hero-card{
  position: relative;border-radius: 1.25rem;overflow: hidden;
  border: 1px solid rgba(255,255,255,.10);
  background: linear-gradient(120deg,
    rgba(16,185,129,.16),
    rgba(34,211,238,.14),
    rgba(16,185,129,.10),
    rgba(34,211,238,.10)
  );
  box-shadow: 0 24px 70px rgba(0,0,0,.55);
}
.hero-glow{
  position:absolute; inset:-60px;
  background:
    radial-gradient(circle at 18% 30%, rgba(16,185,129,.55), transparent 55%),
    radial-gradient(circle at 82% 40%, rgba(34,211,238,.52), transparent 55%),
    radial-gradient(circle at 55% 88%, rgba(16,185,129,.40), transparent 60%),
    radial-gradient(circle at 35% 70%, rgba(34,211,238,.32), transparent 60%);
  filter: blur(20px); opacity:.85;
  animation: floatGlow 10s ease-in-out infinite;
}

.brand-badge{
  display:flex;align-items:center;gap:.5rem;
  padding:.4rem .7rem;border-radius: 999px;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.05);
  backdrop-filter: blur(12px);
}
.brand-dot{
  width:10px;height:10px;border-radius:999px;
  background: linear-gradient(90deg, rgba(16,185,129,1), rgba(34,211,238,1));
  box-shadow: 0 0 18px rgba(34,211,238,.25);
  animation: pulseDot 2.2s ease-in-out infinite;
}

.table-wrap{ border-radius: 1rem; overflow: hidden; border: 1px solid rgba(255,255,255,.10); }
.hover-row{ transition: transform .14s ease, background .14s ease; }
.hover-row:hover{ transform: translateX(2px); background: rgba(255,255,255,.06); }

.fade-in{ animation: fadeInUp .28s ease both; }
@keyframes fadeInUp{ from{opacity:0;transform: translateY(10px);} to{opacity:1;transform: translateY(0);} }

.spinner{
  width: 36px;height: 36px;border-radius: 999px;
  border: 3px solid rgba(255,255,255,.18);
  border-top-color: rgba(34,211,238,.65);
  animation: spin 1s linear infinite;
}
@keyframes spin{ to{ transform: rotate(360deg); } }

.aurora-bg{
  position: fixed; inset: -30%; z-index: 0;
  background:
    radial-gradient(circle at 12% 22%, rgba(16,185,129,.42), transparent 58%),
    radial-gradient(circle at 86% 28%, rgba(34,211,238,.40), transparent 58%),
    radial-gradient(circle at 50% 86%, rgba(16,185,129,.34), transparent 62%),
    radial-gradient(circle at 28% 72%, rgba(34,211,238,.28), transparent 62%),
    radial-gradient(circle at 70% 68%, rgba(16,185,129,.24), transparent 64%);
  filter: blur(22px) saturate(1.35);
  animation: auroraMove 12s ease-in-out infinite;
}
.aurora-noise{
  position: fixed; inset: 0; z-index: 1;
  pointer-events: none; opacity: .08;
  background-image:
    url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='320' height='320'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='320' height='320' filter='url(%23n)' opacity='.6'/%3E%3C/svg%3E");
  mix-blend-mode: overlay;
}
@keyframes auroraMove{
  0%{ transform: translate3d(-2%, -1%, 0) scale(1.02); }
  50%{ transform: translate3d(2%, 1%, 0) scale(1.05); }
  100%{ transform: translate3d(-2%, -1%, 0) scale(1.02); }
}
@keyframes floatGlow{
  0%{ transform: translate3d(-1%, -1%, 0) scale(1.02); }
  50%{ transform: translate3d(1%, 1%, 0) scale(1.05); }
  100%{ transform: translate3d(-1%, -1%, 0) scale(1.02); }
}
@keyframes pulseDot{
  0%,100%{ transform: scale(1); opacity: .9; }
  50%{ transform: scale(1.18); opacity: 1; }
}

/* Full-screen random color deviation overlay */
.transition-overlay{
  position: fixed;
  inset: 0;
  z-index: 9999;
  pointer-events: none;

  opacity: var(--op, 0.85);
  filter: hue-rotate(var(--h, 0deg)) saturate(var(--sat, 1.75)) brightness(var(--bri, 1.18));
  backdrop-filter: blur(var(--blur, 14px)) saturate(1.25);
  -webkit-backdrop-filter: blur(var(--blur, 14px)) saturate(1.25);

  transition: opacity .18s ease;
}
.transition-overlay.out{
  opacity: 0;
  transition: opacity .26s ease;
}
.transition-overlay::before{
  content:"";
  position:absolute;
  inset:-30px;

  /* Randomized ‚Äúpatch‚Äù positions via CSS vars */
  background:
    radial-gradient(circle at var(--x1, 20%) var(--y1, 25%), rgba(16,185,129, var(--a1, .40)), transparent 55%),
    radial-gradient(circle at var(--x2, 80%) var(--y2, 30%), rgba(34,211,238, var(--a2, .36)), transparent 58%),
    radial-gradient(circle at var(--x3, 55%) var(--y3, 82%), rgba(16,185,129, var(--a3, .28)), transparent 62%),
    radial-gradient(circle at var(--x4, 30%) var(--y4, 70%), rgba(34,211,238, var(--a4, .22)), transparent 62%);

  mix-blend-mode: screen;
  filter: blur(18px);
}
</style>

</body>
</html>
